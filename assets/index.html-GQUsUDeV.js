import{_ as i,c as a,a as e,o as n}from"./app-rzor12pK.js";const t={};function h(l,s){return n(),a("div",null,s[0]||(s[0]=[e(`<h2 id="一、背景说明" tabindex="-1"><a class="header-anchor" href="#一、背景说明"><span>一、背景说明</span></a></h2><p>在企业网络安全管理过程中，网络资产管理至关重要。从以往的安全事件及护网期间被攻破的案例来看，未纳入管理范围的资产往往成为攻击者的主要突破口，占比较高。 尽管公司实施了网络资产备案机制，以确保日常网络安全隐患排查与快速定位，但仍有“百密一疏”的情况。一旦未备案资产出现安全风险，往往很难做到短时间内快速响应、处置并锁定涉事资产。 本文结合实际案例，探讨如何有效快速地排查和处置未备案的网络安全隐患资产，帮助值守人员应对此类问题。</p><h2 id="三、案例背景" tabindex="-1"><a class="header-anchor" href="#三、案例背景"><span>三、案例背景</span></a></h2><p>某日某时，网络安全监测人员通过威胁感知系统发现内部网络中有一台主机感染了挖矿病毒，试图连接外部挖矿网络。网络安全监测人员在态势感知中发现问题资产后，立即发出告警，排查处置组立即开展事件处置。</p><h2 id="二、工具与流程" tabindex="-1"><a class="header-anchor" href="#二、工具与流程"><span>二、工具与流程</span></a></h2><h3 id="工具列表" tabindex="-1"><a class="header-anchor" href="#工具列表"><span>工具列表</span></a></h3><table><thead><tr><th>工具名称</th><th>用途</th><th>下载地址</th></tr></thead><tbody><tr><td>态势感知平台</td><td>安全监测、安全事件分析、安全事件告警</td><td></td></tr><tr><td>APT</td><td>持续监控、威胁情报收集、攻击行为分析</td><td></td></tr><tr><td>防火墙</td><td>IP地址封堵、阻断</td><td></td></tr><tr><td>交换机命令行</td><td>设备MAC溯源、ACL阻断策略</td><td></td></tr><tr><td>Linux命令行</td><td>分析取证</td><td></td></tr><tr><td>Windwos命令行</td><td>分析取证</td><td></td></tr><tr><td>TCP/viewer</td><td>Widnows端口占用分析</td><td><a href="https://download.sysinternals.com/files/TCPView.zip" target="_blank" rel="noopener noreferrer">TCPView.</a></td></tr><tr><td>Log parser</td><td>Windows 日志分析工具</td><td><a href="https://www.microsoft.com/en-us/download/details.aspx?id=24659" target="_blank" rel="noopener noreferrer">Log parser</a></td></tr><tr><td>PCHunter</td><td>Windows 进程分析工具</td><td><a href="https://www.52pojie.cn/thread-1821221-1-1.html" target="_blank" rel="noopener noreferrer">page</a></td></tr><tr><td>Process Explorer</td><td>Windows进程分析工具</td><td>https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer</td></tr><tr><td>process hacker</td><td>Windows进程分析工具</td><td><a href="https://processhacker.sourceforge.io/" target="_blank" rel="noopener noreferrer">Process Hacker</a></td></tr><tr><td>Autoruns</td><td>用于管理自启动项和自动执行程序</td><td><a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/autoruns" target="_blank" rel="noopener noreferrer">Autoruns - Sysinternals | Microsoft Learn</a></td></tr><tr><td>chkrootkit</td><td>Linux系统Rootkit 查杀（开源）</td><td>https://www.chkrootkit.org/</td></tr><tr><td>rkhunter</td><td>Linux 系统rootkit 检测工具（开源）</td><td><a href="https://rkhunter.sourceforge.net/" target="_blank" rel="noopener noreferrer">Rootkit Hunter 项目</a></td></tr><tr><td>Clamav</td><td>病毒查杀工具（开源）</td><td><a href="https://www.clamav.net/download.html" target="_blank" rel="noopener noreferrer">ClamAVNet</a></td></tr><tr><td>河马webshell查杀</td><td>webshell 查杀工具</td><td><a href="https://www.shellpub.com/" target="_blank" rel="noopener noreferrer">SHELLPUB.COM 专注查杀，永久免费</a></td></tr><tr><td>奇安信顽固病毒专杀工具</td><td>针对多种顽固木马与恶意程序</td><td><a href="https://www.qianxin.com/other/qaxvirusremoval" target="_blank" rel="noopener noreferrer">Download</a></td></tr><tr><td>深信服僵尸网络查杀工具</td><td>针对僵尸网络的专杀工具</td><td><a href="http://edr.sangfor.com.cn/tool/SfabAntiBot_X86.7z" target="_blank" rel="noopener noreferrer">Download</a></td></tr><tr><td>深信封挖矿病毒巡检工具</td><td>针对挖矿病毒的专杀工具</td><td><a href="https://download.sangfor.com.cn/%20download/Mining_Inspection_X64.zip" target="_blank" rel="noopener noreferrer">Download</a></td></tr><tr><td>火绒恶性木马专杀工具</td><td>针对顽固病毒、木马的专杀工具</td><td><a href="https://bbs.huorong.cn/thread-18575-1-1.html" target="_blank" rel="noopener noreferrer">Page</a></td></tr></tbody></table><h3 id="处置流程" tabindex="-1"><a class="header-anchor" href="#处置流程"><span>处置流程</span></a></h3><p>安全事件的处置应该从安全监测中发现问题开始，是否能够发现安全事件，不但依赖于功能强大的安全监测设备和工具，更依赖于专业的安全监测和分析人员，二者缺一不可。下面是一个从“发现问题”开始的简单的安全事件处置流程，能够帮助现场值守和事件处置人员更好的理解安全事件处置过程。</p><h2 id="四、事件处置" tabindex="-1"><a class="header-anchor" href="#四、事件处置"><span>四、事件处置</span></a></h2><h3 id="事件监测" tabindex="-1"><a class="header-anchor" href="#事件监测"><span>事件监测</span></a></h3><p>安全事件监测是信息安全管理中至关重要的一环,公司网络安全监测人员通过态势感知、ATP、IPS、WAF、日志分析等专业设备实时对网络进行监控，一旦发现可疑IP或MAC地址，立即通知排查处置组，进行资产定位，启动处置流程。 某日下午某时分，网路安全监测人员通过威胁感知系统发现内部网络中出现挖矿主机病毒连接外部挖矿网络（122.10.35.57），经监测此地址确实为外部挖矿地址。</p><h3 id="事件抑制" tabindex="-1"><a class="header-anchor" href="#事件抑制"><span>事件抑制</span></a></h3><h4 id="第一步-锁定资产" tabindex="-1"><a class="header-anchor" href="#第一步-锁定资产"><span>第一步：锁定资产</span></a></h4><p>首先应通过<strong>桌面安全管理平台</strong> 查询该资产（IP地址）的注册情况。若未能查到注册情况，应进一步通过对防火墙、WAF、APT等设备日志进行分析，通过查看工作时间内访问IP地址的频率，判断该主机归属单位。若任未确定该主机归属，应进行以下步骤对资产进行定位：</p><p><strong>确定IP地址归属单位，定位网络接入节点：</strong> 单位在网络建设之初应对各单位进行网络规划，为各个单位分配不同的网段，如果能够知道该IP地址归属哪个单位，并确定其接入边界。若无法确定IP地址归属单位，应在核心交换机上排查其对应MAC对应接口，并逐级溯源，确定其接入边界。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">disddisplay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mac-address</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 94:3b:b0:0c:20:4f</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">display</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mac-address</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 94:3b:b0:0c:20:4f</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">show</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mac</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> address-table</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dynamic</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> address</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 94:3b:b0:0c:20:4f</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="第二步-断网处置" tabindex="-1"><a class="header-anchor" href="#第二步-断网处置"><span>第二步： 断网处置</span></a></h4><p>在确定风险地址接入节边界后，应通过物理隔离或逻辑隔离的方式，禁止其访问上级网络。物理隔离方式既拔掉风险主机网线。逻辑隔离方式既：在其接入边界设备（防火墙等）上对该地址进行封禁，若接入边界无防火墙等安全设备，则需在接入节点交换机或路由器上进行封禁。</p><p>在进行物理隔离或逻辑隔离后，应通知涉事单位进一步确定资产位置。</p><h5 id="防火墙阻断策略" tabindex="-1"><a class="header-anchor" href="#防火墙阻断策略"><span><strong>防火墙阻断策略</strong></span></a></h5><table><thead><tr><th>源地址</th><th>源端口</th><th>目的地址</th><th>目的端口</th><th>动作</th></tr></thead><tbody><tr><td>x.x.x.x</td><td>any</td><td>any</td><td>any</td><td>deny</td></tr></tbody></table><h5 id="网络设备阻断策略" tabindex="-1"><a class="header-anchor" href="#网络设备阻断策略"><span><strong>网络设备阻断策略</strong></span></a></h5><p>在交换机或路由器上对风险IP进行封禁，需要首先配置CAL策略，然后在MAC流入的端口上启用对应的ACL策略：</p><h6 id="华为交换" tabindex="-1"><a class="header-anchor" href="#华为交换"><span>华为交换</span></a></h6><p><strong>进入系统视图</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;HUAWEI&gt; system-view</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>创建标准ACL</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[HUAWEI] acl 2000</span></span>
<span class="line"><span>[HUAWEI-acl-basic-2000] rule deny source 122.10.35.57 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>将ACL应用到接口</strong></p><p>假设我们要将ACL应用到接口GigabitEthernet0/1：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[HUAWEI] interface GigabitEthernet0/1</span></span>
<span class="line"><span>[HUAWEI-GigabitEthernet0/1] traffic-filter inbound acl 2000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="华三交换机" tabindex="-1"><a class="header-anchor" href="#华三交换机"><span>华三交换机</span></a></h6><p><strong>进入系统视图</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;H3C&gt; system-view</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>创建标准ACL</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[H3C] acl number 2000</span></span>
<span class="line"><span>[H3C-acl-basic-2000] rule deny source 122.10.35.57 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>将ACL应用到接口</strong></p><p>假设我们要将ACL应用到接口GigabitEthernet0/1：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[H3C] interface GigabitEthernet0/1</span></span>
<span class="line"><span>[H3C-GigabitEthernet0/1] packet-filter inbound acl-number 2000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="思科交换机" tabindex="-1"><a class="header-anchor" href="#思科交换机"><span>思科交换机</span></a></h6><p><strong>进入全局配置模式</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>Switch&gt; enable</span></span>
<span class="line"><span>Switch# configure terminal</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建标准ACL</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>Switch(config)# access-list 1 deny 122.10.35.57</span></span>
<span class="line"><span>Switch(config)# access-list 1 permit any</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>将ACL应用到接口</strong></p><p>假设我们要将ACL应用到接口GigabitEthernet0/1：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>Switch(config)# interface GigabitEthernet0/1</span></span>
<span class="line"><span>Switch(config-if)# ip access-group 1 in</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>完成对涉事主机的IP地址进行封禁后，安全监测人员需密切注意该网段是否有类似隐患信息地址出现，防止主机通过更改IP地址再次上线。</p><h3 id="事件取证" tabindex="-1"><a class="header-anchor" href="#事件取证"><span>事件取证</span></a></h3><p>在完成主机定位后，排查处置组应立即开展事件取证工作。对于主机的取证分析工作，可以从进程、目录、文件、用户、日志5个方面出发进行。</p><h4 id="端口与进程排查" tabindex="-1"><a class="header-anchor" href="#端口与进程排查"><span>端口与进程排查</span></a></h4><h5 id="windows" tabindex="-1"><a class="header-anchor" href="#windows"><span>Windows</span></a></h5><p>使用TCP/viewer 或命令命令行查看端口占用进程 <strong>TCP/viewer</strong> 通过TCP查看器进行查看发现主机运行程序中（进程ID 3264）存在与通报预警相同的连接行为。</p><p><strong>命令行</strong></p><ul><li>查看端口占用：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ano</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>查看对应的进程名称</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tasklist</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> findstr</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>查看进程详细信息 开 始 --运 行 --输 入<code>msinfo32</code>， 依 次 点 击 “软 件 环 境 →正 在 运 行 任 务 ”就可 以 查 看 到 进 程 的 详 细 信 息 ， 比 如 进 程 路 径 、 进 程 ID、 文 件 创 建 日 期 、 启动 时 间 等 。</li></ul><h5 id="linux" tabindex="-1"><a class="header-anchor" href="#linux"><span>Linux</span></a></h5><ul><li>端口占用</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -plan</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -plant</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -lpenaut</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ss</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ss</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -plantu</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>进程查询</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">top</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # or htop 查看资源占用情况</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ps</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -auxwf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pstree</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -h</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #查看进程树</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lsof</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 运行进程监听端口的细节信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lsof</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [pid] </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 显示进程使用的所有文件和端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lsof</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -iTCP</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -P</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #显示监听的TCP端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lsof</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -R</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [pid] </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 显示父进程ID</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="开机启动项与计划任务分析" tabindex="-1"><a class="header-anchor" href="#开机启动项与计划任务分析"><span>开机启动项与计划任务分析</span></a></h4><h5 id="windows-1" tabindex="-1"><a class="header-anchor" href="#windows-1"><span>Windows</span></a></h5><p><strong>检查组策略开关机脚本</strong> Win + R 输入gpedit.msc 查看Windows设置中是否存在开机关机脚本：</p><p><strong>检查开机自启动项</strong></p><p>Win + R，输 入 msconfig，打开任务管理器，查 看 是 否 存 在 命 名异 常 的 启 动 项 目 ， 是 则 取 消 勾 选 命 名 异 常 的 启 动 项 目 ， 并 到 命 令 中显 示 的 路 径 删 除 文 件 。</p><p><strong>检查计划任务</strong> 单 击 【 开 始 】 &gt;【 设 置 】 &gt;【 控 制 面 板 】 &gt;【 任 务 计 划 】， 查 看 计 划 任 务 属性 ， 便 可 以 发 现 木 马 文 件 的 路 径 。</p><h5 id="linux-1" tabindex="-1"><a class="header-anchor" href="#linux-1"><span>Linux</span></a></h5><p><strong>检查开机启动项</strong></p><p>查看 /etc/rc*.d/的文件，是否有异常启动项</p><p><strong>检查定时任务</strong></p><p>重点查看以下目录是否有恶意脚本：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /var/spool/cron/*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/crontab</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/cron.d/*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/cron.daily/*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/cron.hourly/*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/cron.monthly/*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/cron.weekly/</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/anacrontab</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /var/spool/anacron/*</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="日志分析" tabindex="-1"><a class="header-anchor" href="#日志分析"><span>日志分析</span></a></h4><h5 id="windows-2" tabindex="-1"><a class="header-anchor" href="#windows-2"><span>Windows</span></a></h5><p>Win+R 打 开 运 行 ， 输 入 “eventvwr.msc”， 回 车 运 行 ， 打 开 “事 件 查看 器 ”查看日志。</p><p>或导 出 应 用 程 序 日 志 、安 全 日 志 、系 统 日 志 ，利 用 Log Parser 进 行 分 析：</p><p><strong>Log Parser 使用</strong></p><ul><li>按时间查询</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">logparser</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i:evt</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o:DATAGRID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select TimeGenerated,TimeWritten,EventType,Strings from S.evtx where TimeGenerated&gt;timestamp(&#39;2021-12-01&#39;,&#39;yyyy-MM-dd&#39;)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>指定IP地址查询</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">logparser</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i:evt</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o:DATAGRID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select EXTRACT_TOKEN(strings,19,&#39;|&#39;) as LoginIp,EXTRACT_TOKEN(strings,17,&#39;|&#39;) as ProcessName,message from dd.evtx where TimeGenerated&gt;timestamp(&#39;2022-02-05&#39;,&#39;yyyy-MM-dd&#39;) and EXTRACT_TOKEN(strings,19,&#39;|&#39;)=&#39;IP地址&#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>指定事件ID查询</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">logparser</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i:evt</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o:DATAGRID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select * from S.evtx where eventid=4625</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>导出CSV文件</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">logparser</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i:evt</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o:CSV</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">select EXTRACT_TOKEN(strings,19,&#39;|&#39;) as LoginIp,EXTRACT_TOKEN(strings,17,&#39;|&#39;) as ProcessName,message from dd.evtx where TimeGenerated&gt;timestamp(&#39;2022-02-05&#39;,&#39;yyyy-MM-dd&#39;) and EXTRACT_TOKEN(strings,19,&#39;|&#39;)=&#39;172.16.219.56&#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5.csv</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="linux-2" tabindex="-1"><a class="header-anchor" href="#linux-2"><span>Linux</span></a></h5><ul><li>日 志 默 认 存 放 位 置 ： <code>/var/log/</code></li><li>安全事件（如登录、授权、ssh连接等）日志通常记录以下日志文件中 <ul><li>Debian/Ubuntu等发行版：<code>/var/log/auth.log</code></li><li>Redhat/Centos/Fedora等发行版：<code>/var/log/secure</code></li></ul></li></ul><p>查 看 日 志 配 置 情 况 ： <code>more /etc/rsyslog.conf</code></p><p><strong>日 志 分 析 技 巧</strong></p><ul><li>定 位 有 多 少 IP 在 爆 破 主 机 的 root 帐 号 ：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Failed password for root</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> awk</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{print $11}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sort</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> uniq</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sort</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -nr</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> more</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>定位有哪些 IP 在爆破：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Failed password</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -E</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">uniq</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>爆破用户名字典是什么？</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Failed password</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">perl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">while($_=&lt;&gt;){ /for(.*?) from/; print &quot;$1\\n&quot;;}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">uniq</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sort</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -nr</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>录 成 功 的 IP 有 哪 些 ：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Accepted </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> awk</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{print $11}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sort</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> uniq</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sort</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -nr</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> more</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>登 录 成 功 的 日 期 、 用 户 名 、 IP：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Accepted </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> awk</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{print $1,$2,$3,$9,$11}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>查找增加用户的日志</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;useradd&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/var/log/secure</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>查找删除用户的日志</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;userdel&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/var/log/secure</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>使用su 和 sudo命的日志</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">su</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sudo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log/secure</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="病毒查杀" tabindex="-1"><a class="header-anchor" href="#病毒查杀"><span>病毒查杀</span></a></h4><h5 id="windows-3" tabindex="-1"><a class="header-anchor" href="#windows-3"><span>WIndows</span></a></h5><p>建议优先使用商业版杀毒软件查杀，个别病毒需要使用专杀工具，如火绒恶性木马专杀工具、深信服僵尸网络查杀工具、深信服挖矿病毒巡检工具、奇安信顽固病毒专杀工具、D盾（Webshell查杀）等，详见工具列表。</p><h5 id="linux-3" tabindex="-1"><a class="header-anchor" href="#linux-3"><span>Linux</span></a></h5><p>建议优先使用商业版杀毒软件查杀，开源工具具有一定的风险，非专业人士请谨慎使用。常用工具详见工具列表。</p><p><strong>RPM check 检查</strong> 系统完整性可以通过 rpm 自带的-Va 来校验检查所有的 rpm 软件包， 查看哪些命令是否被替换了：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rpm</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -Va</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rpm.log</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>验证结果的输出包括以下几种字符，表示不同的检查结果：</p><table><thead><tr><th>输出结果</th><th>含义</th></tr></thead><tbody><tr><td><strong>S</strong></td><td>文件的大小不同</td></tr><tr><td><strong>M</strong></td><td>文件的模式（权限）不同</td></tr><tr><td><strong>5</strong></td><td>文件的 MD5 校验和不同</td></tr><tr><td><strong>D</strong></td><td>设备的主设备号或从设备号不同</td></tr><tr><td><strong>L</strong></td><td>文件的符号链接路径不同</td></tr><tr><td><strong>U</strong></td><td>文件的所有者不同</td></tr><tr><td><strong>G</strong></td><td>文件的组所有者不同</td></tr><tr><td><strong>T</strong></td><td>文件的修改时间不同</td></tr><tr><td><strong>P</strong></td><td>文件的多语言转储目录（用于 NLS 文件）</td></tr></tbody></table><h4 id="四、总结" tabindex="-1"><a class="header-anchor" href="#四、总结"><span>四、总结</span></a></h4><ol><li><strong>应急响应策略</strong>：</li></ol><p>- 企业应实施有效的应急响应策略，确保在攻击发生时能够迅速采取行动。首先通过物理或逻辑隔离迅速阻断攻击，防止其扩散。</p><p>- 利用多维度的访问日志信息和人员业务使用习惯的综合分析，能够有效确定涉事资产，为后续的取证、处置和整改提供准确的信息。</p><ol start="2"><li><strong>资产定位方法</strong>：</li></ol><p>- 在企业内部实施IP-MAC绑定策略，或利用准入认证进行绑定。未安装指定软件的终端无法连接网络，确保只有合法终端能够接入。</p><p>- 对于已经认证登入的用户，如出现问题，可以通过追溯到使用该账号的人员，进行精准定位和处理。    - 对于未知IP，需要网络、安全工程师通过网络设备查看ARP表结合安全设备日志进行定位。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">118.184.15.40</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">log_file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/var/log/short_connection_capture.log</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 确保日志目录存在</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/log</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 捕捉短连接的函数</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">capture_short_connection</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    while</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 获取当前端口的连接信息</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        tmp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -anplt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -w</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $ip</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> awk</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -F</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[/]</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{print $1}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> awk</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{print $7}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">$tmp</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ];</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> then</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            ((</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        else</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pid</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $tmp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -d</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> /proc/</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$pid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ];</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> then</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                    # 获取进程信息</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                    exe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">readlink</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /proc/</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$pid</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/exe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                    cmdline</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /proc/</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$pid</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/cmdline</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> tr</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">\\0</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">                    echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PID: $pid, EXE: $exe, CMDLINE: $cmdline</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $log_file</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">                    echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PID: $pid, EXE: $exe, CMDLINE: $cmdline</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                    # 终止进程</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">                    echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Terminating process with PID: $pid</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $log_file</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">                    kill</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -9</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $pid</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                else</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">                    echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PID $pid no longer exists</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $log_file</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                fi</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            done</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            break</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        fi</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 等待1秒后再次检查</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        sleep</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    done</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 运行捕捉函数</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">capture_short_connection</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Total number of times: $i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $log_file</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Total number of times: $i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="脚本说明" tabindex="-1"><a class="header-anchor" href="#脚本说明"><span>脚本说明</span></a></h3><ol><li><strong>日志记录</strong>：增加了日志文件 <code>/var/log/short_connection_capture.log</code>，记录每次捕获的信息和终止进程的操作。</li><li><strong>变量处理</strong>：确保变量处理更安全，使用 <code>$(...)</code> 替换 <code>\`...\`</code>，避免嵌套命令的问题。</li><li><strong>进程检查</strong>：在终止进程前，先检查 <code>/proc/$pid</code> 目录是否存在，确保进程仍然存在。</li><li><strong>进程信息</strong>：获取进程的可执行文件路径和命令行参数，记录在日志中，以便后续分析。</li><li><strong>终止进程</strong>：使用 <code>kill -9</code> 终止进程，确保进程被强制终止。如果需要，可以使用更安全的终止方法（如 <code>kill -15</code>）。</li></ol><h3 id="处置方案" tabindex="-1"><a class="header-anchor" href="#处置方案"><span>处置方案</span></a></h3><ol><li><strong>日志分析</strong>：定期检查日志文件，分析捕获的进程信息，确定是否存在异常行为。</li><li><strong>进程监控</strong>：如果发现某些进程频繁发起短连接，可以进一步监控这些进程的行为，使用工具如 <code>strace</code> 或 <code>auditd</code> 进行深入分析。</li><li><strong>安全措施</strong>：确保脚本在生产环境中运行时，不会误杀关键进程。可以设置白名单或黑名单，确保只有特定的进程会被终止。</li><li><strong>报警通知</strong>：可以将日志文件内容定期发送到管理员邮箱或消息系统，以便及时发现和处理异常情况。</li></ol><p>通过这些优化和处置方案，可以更有效地捕捉和处理短连接的异常行为。</p>`,134)]))}const r=i(t,[["render",h]]),k=JSON.parse('{"path":"/notes/work/%E6%8A%80%E6%88%98%E6%B3%95-%E6%9C%AA%E5%A4%87%E6%A1%88%E8%B5%84%E4%BA%A7%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E6%82%A3%E6%8E%92%E6%9F%A5%E5%88%86%E6%9E%90%E5%A4%84%E7%BD%AE%E6%8A%80%E6%88%98%E6%B3%95_1/","title":"技战法-未备案资产网络安全事件患排查分析处置技战法_1","lang":"zh-CN","frontmatter":{"title":"技战法-未备案资产网络安全事件患排查分析处置技战法_1","createTime":"2024/12/24 09:54:14","permalink":"/notes/work/技战法-未备案资产网络安全事件患排查分析处置技战法_1/"},"headers":[],"readingTime":{"minutes":12.97,"words":3892},"git":{"updatedTime":1747217466000,"contributors":[{"name":"suxiuf","username":"suxiuf","email":"suxiufengcool@163.com","commits":5,"avatar":"https://avatars.githubusercontent.com/suxiuf?v=4","url":"https://github.com/suxiuf"}]},"filePathRelative":"notes/work/技战法-未备案资产网络安全事件患排查分析处置技战法_1.md","categoryList":[{"id":"4358b5","sort":10000,"name":"notes"},{"id":"2215d8","sort":10005,"name":"work"}]}');export{r as comp,k as data};
